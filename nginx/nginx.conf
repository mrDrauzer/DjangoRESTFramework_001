server {
    listen 80;
    server_name _;

    client_max_body_size ${CLIENT_MAX_BODY_SIZE:-16m};

    # Security headers (basic set)
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy strict-origin-when-cross-origin;
    # Content-Security-Policy (CSP) и Permissions-Policy можно включать при необходимости.
    # Вариант 1 (API-only, без фронтенда/Swagger UI) — максимально строгий CSP:
    # add_header Content-Security-Policy "default-src 'none'; frame-ancestors 'none'; base-uri 'none'" always;
    # add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    #
    # Вариант 2 (если отдаёте Swagger UI по /api/docs/) — разрешаем self и inline-скрипты Swagger:
    # ПРИМЕЧАНИЕ: Политику ниже включайте осознанно и тестируйте, так как набор источников зависит
    # от версии Swagger UI и подключаемых ресурсов. При проблемах смотрите ошибки в консоли браузера.
    # add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; frame-ancestors 'none'" always;
    # add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Gzip for text assets
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_vary on;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml application/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # Static files
    location /static/ {
        alias /var/www/static/;
        access_log off;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
    }

    # Media files
    location /media/ {
        alias /var/www/media/;
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
    }

    location / {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
        proxy_connect_timeout 60;
        proxy_send_timeout 300;
    }

    # Optional: simple rate-limiting (commented by default).
    # Uncomment the map/zone in http{} context and the limit directives below if you copy this
    # server block into full nginx.conf. In our single-file default.conf, we skip global setup.
    # Example to protect auth endpoints:
    # limit_req zone=login_zone burst=10 nodelay;
    # location /api/auth/token/ {
    #     limit_req zone=login_zone;
    #     proxy_pass http://web:8000;
    # }
}
